name: Deploy to Google Cloud

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: gcp-demo   # Reference your GitHub Environment

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        run: |
          if [ -n "${{ vars.GCP_WORKLOAD_ID_PROVIDER }}" ] && [ -n "${{ vars.GCP_SA_EMAIL }}" ]; then
            echo "Authenticating to GCP..."
            gcloud auth login --brief --quiet
          else
            echo "GCP environment variables not set, skipping auth..."
          fi
        shell: bash

      - name: Set up gcloud
        run: |
          if [ -n "${{ vars.GCP_PROJECT_ID }}" ]; then
            gcloud config set project "${{ vars.GCP_PROJECT_ID }}"
          else
            echo "GCP_PROJECT_ID not set, skipping gcloud config..."
          fi
        shell: bash

      - name: Verify authentication
        run: |
          echo "Listing authenticated accounts..."
          gcloud auth list || echo "No GCP authentication available."
          gcloud config list project || echo "No project configured."
        shell: bash